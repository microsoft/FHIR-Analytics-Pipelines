steps:
- checkout: self

- download: current
  artifact: 'native-linux-x64'

- download: current
  artifact: 'native-windows-x64'

- script: |
    mkdir -p src/Microsoft.Health.Fhir.Synapse.Parquet/native
    cp -r '$(System.ArtifactsDirectory)/native-linux-x64/' src/Microsoft.Health.Fhir.Synapse.Parquet/native/linux-x64
    cp -r '$(System.ArtifactsDirectory)/native-windows-x64/' src/Microsoft.Health.Fhir.Synapse.Parquet/native/windows-x64
    dotnet pack src/Microsoft.Health.Fhir.Synapse.Parquet/Microsoft.Health.Fhir.Synapse.Parquet.csproj -p:NuspecFile=BuildParquet.nuspec  -p:NuspecProperties="version=$(version)" -c Release -o '$(Build.ArtifactStagingDirectory)/nupkgs'
    dotnet pack src/Microsoft.Health.Fhir.Synapse.Common/Microsoft.Health.Fhir.Synapse.Common.csproj -p:NuspecProperties="version=$(version)" -c Release -o '$(Build.ArtifactStagingDirectory)/nupkgs'
    dotnet pack src/Microsoft.Health.Fhir.Synapse.Core/Microsoft.Health.Fhir.Synapse.Core.csproj -p:NuspecProperties="version=$(version)" -c Release -o '$(Build.ArtifactStagingDirectory)/nupkgs'
    dotnet pack src/Microsoft.Health.Fhir.Synapse.DataClient/Microsoft.Health.Fhir.Synapse.DataClient.csproj -p:NuspecProperties="version=$(version)" -c Release -o '$(Build.ArtifactStagingDirectory)/nupkgs'
    dotnet pack src/Microsoft.Health.Fhir.Synapse.DataWriter/Microsoft.Health.Fhir.Synapse.DataWriter.csproj -p:NuspecProperties="version=$(version)" -c Release -o '$(Build.ArtifactStagingDirectory)/nupkgs'
    dotnet pack src/Microsoft.Health.Fhir.Synapse.SchemaManagement/Microsoft.Health.Fhir.Synapse.SchemaManagement.csproj -p:NuspecProperties="version=$(version)" -c Release -o '$(Build.ArtifactStagingDirectory)/nupkgs'

  workingDirectory: FhirToDataLake
  displayName: Nuget pack

- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: '$(Build.ArtifactStagingDirectory)/nupkgs'
    artifactName: 'parquetnugetpack' 

- task: NuGetCommand@2
  displayName: 'NuGet push'
  inputs:
    command: push
    publishVstsFeed: 'FhirAnalytics/FhirAnalyticsPublic'
    allowPackageConflicts: true
    packagesToPush: '$(Build.ArtifactStagingDirectory)/nupkgs/*.nupkg'

