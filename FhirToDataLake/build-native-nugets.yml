steps:
- checkout: self
  submodules: true

- script: |
    sudo apt update
    sudo apt install -y -V ca-certificates lsb-release wget
    wget https://apache.jfrog.io/artifactory/arrow/$(lsb_release --id --short | tr 'A-Z' 'a-z')/apache-arrow-apt-source-latest-$(lsb_release --codename --short).deb
    sudo apt install -y -V ./apache-arrow-apt-source-latest-$(lsb_release --codename --short).deb
    sudo apt-get update
    sudo apt-get install -y libarrow-dev=8.0.0-1 libparquet-dev=8.0.0-1
  displayName: 'Install Arrow'

- task: CMake@1
  displayName: CMake generate configuration
  inputs:
    workingDirectory: FhirToDataLake/src/Microsoft.Health.Fhir.Synapse.Parquet.Native
    cmakeArgs: " -B build -S ."

- task: CMake@1
  displayName: CMake build
  inputs:
    workingDirectory: FhirToDataLake/src/Microsoft.Health.Fhir.Synapse.Parquet.Native
    cmakeArgs: " --build build --config Release"    

- script: make test ARGS=-V
  workingDirectory: FhirToDataLake/src/Microsoft.Health.Fhir.Synapse.Parquet.Native/build
  displayName: Run native tests

- script: | 
    mkdir -p ../Microsoft.Health.Fhir.Synapse.Parquet/bin
    cp build/src/libParquetNative.so ../Microsoft.Health.Fhir.Synapse.Parquet/bin
  workingDirectory: FhirToDataLake/src/Microsoft.Health.Fhir.Synapse.Parquet.Native
  displayName: Copy native library

- script: |
    dotnet pack src/Microsoft.Health.Fhir.Synapse.Parquet/Microsoft.Health.Fhir.Synapse.Parquet.csproj -p:NuspecFile=BuildParquet.nuspec  -p:NuspecProperties="version=$(version)" -c Release -o '$(Build.ArtifactStagingDirectory)/nupkgs'
    dotnet pack src/Microsoft.Health.Fhir.Synapse.Common/Microsoft.Health.Fhir.Synapse.Common.csproj -p:NuspecProperties="version=$(version)" -c Release -o '$(Build.ArtifactStagingDirectory)/nupkgs'
    dotnet pack src/Microsoft.Health.Fhir.Synapse.Core/Microsoft.Health.Fhir.Synapse.Core.csproj -p:NuspecProperties="version=$(version)" -c Release -o '$(Build.ArtifactStagingDirectory)/nupkgs'
    dotnet pack src/Microsoft.Health.Fhir.Synapse.DataClient/Microsoft.Health.Fhir.Synapse.DataClient.csproj -p:NuspecProperties="version=$(version)" -c Release -o '$(Build.ArtifactStagingDirectory)/nupkgs'
    dotnet pack src/Microsoft.Health.Fhir.Synapse.DataWriter/Microsoft.Health.Fhir.Synapse.DataWriter.csproj -p:NuspecProperties="version=$(version)" -c Release -o '$(Build.ArtifactStagingDirectory)/nupkgs'
    dotnet pack src/Microsoft.Health.Fhir.Synapse.SchemaManagement/Microsoft.Health.Fhir.Synapse.SchemaManagement.csproj -p:NuspecProperties="version=$(version)" -c Release -o '$(Build.ArtifactStagingDirectory)/nupkgs'

  workingDirectory: FhirToDataLake
  displayName: Nuget pack

- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: '$(Build.ArtifactStagingDirectory)/nupkgs'
    artifactName: 'parquetnugetpack' 

- task: NuGetCommand@2
  displayName: 'NuGet push'
  inputs:
    command: push
    publishVstsFeed: 'FhirAnalytics/FhirAnalyticsPublic'
    allowPackageConflicts: true
    packagesToPush: '$(Build.ArtifactStagingDirectory)/nupkgs/*.nupkg'

